defaults: &defaults
  docker:
    - image: continuumio/miniconda3
  environment:
    DATABASE_DIR: .test/databases
    WORKING_DIR: .test/Dryrun
    N_THREADS: 4
    MEM: 4

version: 2

jobs:
  build:
    <<: *defaults
    parallelism: 1
    steps:
      - checkout
      - run: pwd
      - run:
          name: Setup conda
          command: |
           conda config --add channels bioconda
           conda config --add channels conda-forge
           conda config --set always_yes true
           conda init bash
           conda env create -p /atlasenv
      - restore_cache:
          key: atlasenv-{{ checksum "atlasenv.yml" }}
      - run:
          name: install dependencies
          command:  conda env update -p /atlasenv --file atlasenv.yml
      - save_cache:
          key: atlasenv-{{ checksum "atlasenv.yml" }}
          paths:
            - "/atlasenv"
      - run:
          name: Install atlas
          command: |
              source activate /atlasenv
              python setup.py install
              conda list
              atlas --help
              atlas --version
      - run:
          name: Dryrun
          command: |
              source activate /atlasenv
              .test/dryrun.sh
      - restore_cache:
          key: conda-envs-{{ tar -c atlas/envs | checksum  }}
      - run:
          name: install environements
          command: |
              source activate /atlasenv
              atlas run all -w $WORKING_DIR --create-envs-only
              atlas run None -w $WORKING_DIR logs/checkm_init.txt
      - save_cache:
          key: conda-envs-{{ tar -c atlas/envs | checksum  }}
          paths:
            - $DATABASE_DIR

#      - run: .test/test_assembly.sh




workflows:
  version: 2
  build_and_test:
    jobs:
      - build
