defaults: &defaults
  docker:
    - image: continuumio/miniconda3
  environment:
    DATABASE_DIR: /databases

version: 2

jobs:
  build:
    <<: *defaults
    resource_class: small
    environment:
      N_THREADS: 1
      MEM: 2
      WORKING_DIR: .test/Dryrun
    steps:
      - checkout
      - run: pwd
      - run:
          name: Setup conda
          command: |
           conda config --add channels bioconda
           conda config --add channels conda-forge
           conda config --set always_yes true
      - restore_cache:
          key: atlasenv-dependencies-{{ checksum "atlasenv.yml" }}
      - run:
          name: install dependencies
          command:  |
              if [ -d "/atlasenv" ]; then
                echo "atlasenv exist already";
                source activate /atlasenv
                conda list
              else
                conda create -p /atlasenv --file atlasenv.yml
              fi
      - save_cache:
          key: atlasenv-dependencies-{{ checksum "atlasenv.yml" }}
          paths:
            - "/atlasenv"
      - run:
          name: Install atlas
          command: |
              source activate /atlasenv
              python setup.py install
              conda list
              atlas --help
              atlas --version
      - run:
          name: short test
          command: |
              source activate /atlasenv
              atlas --help
              atlas --version
      - run:
          name: Dryrun
          command: |
              source activate /atlasenv
              .test/dryrun.sh
      - store_artifacts:
          path: .test/Dryrun/.snakemake/log
          destination: dryrun
      - store_test_results:
          path: .test/Dryrun/.snakemake/log

      - persist_to_workspace:
          root: /
          paths:
            - atlasenv
            - root/project


  getenvs:
    <<: *defaults
    resource_class: small
    steps:
      - attach_workspace:
          at: /
      - run: cd /root/project/
      - run: tar -cf conda_envs.tar atlas/envs
      - restore_cache:
          key: conda-envs-{{ checksum "conda_envs.tar"  }}
      - run:
          name: Init
          command: |
              source activate /atlasenv
              atlas init --db-dir $DATABASE_DIR --threads 1 -w .test/Getenvs .test/reads/empty

      - run:
          name: install environements
          command: |
              source activate /atlasenv
              atlas run all -w .test/Getenvs --create-envs-only
      - save_cache:
          key: conda-envs-{{ checksum "conda_envs.tar"  }}
          paths:
            - $DATABASE_DIR
      - persist_to_workspace:
          root: /
          paths:
            - databases


# download checkm data
#              atlas run None -w .test/Getenvs logs/checkm_init.txt

  assembly:
    <<: *defaults
    environment:
      N_THREADS: 4
      MEM: 8
    resource_class: large
    steps:
      - attach_workspace:
          at: /
      - run: git clone https://github.com/metagenome-atlas/example_data.git
      - run:
          name: test assembly
          command: |
              source activate /atlasenv
              .test/test_assembly.sh --resources mem=$MEM --jobs=$N_THREADS --restart-times=2




workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - getenvs:
          requires:
            - build
      - assembly:
          requires:
            - build
